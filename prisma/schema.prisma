// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Seed script configuration
// Run with: npm run prisma:seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SALES
  OPERATIONS
  FINANCE
  MANAGEMENT
}

enum ProjectType {
  RESIDENTIAL_SUBSIDY
  RESIDENTIAL_NON_SUBSIDY
  COMMERCIAL_INDUSTRIAL
}

enum ProjectStatus {
  LEAD
  CONFIRMED
  UNDER_INSTALLATION
  SUBMITTED_FOR_SUBSIDY
  COMPLETED
  COMPLETED_SUBSIDY_CREDITED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  FULLY_PAID
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdProjects  Project[]    @relation("CreatedBy")
  salesProjects    Project[]    @relation("SalesPerson")
  uploadedDocuments Document[]  @relation("UploadedBy")
  auditLogs        AuditLog[]   @relation("AuditUser")

  @@map("users")
}

model Project {
  id        String   @id @default(cuid())
  slNo      Int      @unique @default(autoincrement())
  
  // Customer Details
  customerName      String
  address           String?
  contactNumbers    String? // JSON array of phone numbers
  consumerNumber    String?
  type              ProjectType
  leadSource        String?
  leadBroughtBy     String?
  salespersonId     String?
  year              String // FY format: "2024-25"
  count             Int     @default(1)

  // Sales & Commercial
  systemCapacity        Float?   // kW
  projectCost           Float?   // â‚¹
  confirmationDate      DateTime?
  loanDetails           String?  // JSON: { hasLoan: boolean, remarks: string }
  incentiveEligible     Boolean  @default(false)
  expectedProfit        Float?   // Auto-calculated
  finalProfit           Float?

  // Project Execution & Compliance
  mnrePortalRegistrationDate    DateTime?
  feasibilityDate               DateTime? // KSEB
  registrationDate              DateTime? // KSEB
  installationCompletionDate    DateTime?
  mnreInstallationDetails       String?  // JSON or text
  subsidyRequestDate            DateTime?
  subsidyCreditedDate           DateTime?
  projectStatus                 ProjectStatus @default(LEAD)

  // Payment Tracking
  advanceReceived       Float?   @default(0)
  advanceReceivedDate   DateTime?
  payment1              Float?   @default(0)
  payment1Date          DateTime?
  payment2              Float?   @default(0)
  payment2Date          DateTime?
  payment3              Float?   @default(0)
  payment3Date          DateTime?
  lastPayment           Float?   @default(0)
  lastPaymentDate       DateTime?
  totalAmountReceived   Float    @default(0) // Auto-calculated
  balanceAmount         Float    @default(0) // Auto-calculated
  paymentStatus         PaymentStatus @default(PENDING) // Auto-calculated

  // Remarks & Documentation
  remarks       String?  @db.Text
  internalNotes String? @db.Text // Sales only

  // Relations
  createdById String
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])
  
  salesperson User?  @relation("SalesPerson", fields: [salespersonId], references: [id], onDelete: SetNull)

  documents Document[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

model Document {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  fileName    String
  filePath    String
  fileType    String   // MIME type
  fileSize    Int      // bytes
  category    String   // proposal, agreement, kseb, mnre, invoice, payment_proof
  description String?
  
  uploadedById String
  uploadedBy   User   @relation("UploadedBy", fields: [uploadedById], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("documents")
}

model AuditLog {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User    @relation("AuditUser", fields: [userId], references: [id])
  
  action    String  // created, updated, deleted, status_changed, payment_updated, etc.
  field     String? // which field was changed
  oldValue  String? @db.Text
  newValue  String? @db.Text
  remarks   String? @db.Text
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

