// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Seed script configuration
// Run with: npm run prisma:seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SALES
  OPERATIONS
  FINANCE
  MANAGEMENT
}

enum ProjectType {
  RESIDENTIAL_SUBSIDY
  RESIDENTIAL_NON_SUBSIDY
  COMMERCIAL_INDUSTRIAL
}

enum ProjectStatus {
  LEAD
  SITE_SURVEY
  PROPOSAL
  CONFIRMED
  UNDER_INSTALLATION
  SUBMITTED_FOR_SUBSIDY
  COMPLETED
  COMPLETED_SUBSIDY_CREDITED
  LOST
}

enum PaymentStatus {
  PENDING
  PARTIAL
  FULLY_PAID
}

enum ProjectServiceType {
  EPC_PROJECT
  PANEL_CLEANING
  MAINTENANCE
  REPAIR
  CONSULTING
  RESALE
  OTHER_SERVICES
}

enum CustomerType {
  RESIDENTIAL
  APARTMENT
  COMMERCIAL
}

enum LeadSource {
  WEBSITE
  REFERRAL
  GOOGLE
  CHANNEL_PARTNER
  DIGITAL_MARKETING
  SALES
  MANAGEMENT_CONNECT
  OTHER
}

enum LeadStatus {
  NEW
  QUALIFIED
  LOST
  CONVERTED
}

enum SystemType {
  ON_GRID
  OFF_GRID
  HYBRID
}

enum ProjectStage {
  SURVEY
  PROPOSAL
  APPROVED
  INSTALLATION
  BILLING
  LIVE
  AMC
  LOST
}

enum LostReason {
  LOST_TO_COMPETITION
  NO_BUDGET
  INDEFINITELY_DELAYED
  OTHER
}

enum ProposalStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
}

enum InstallationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum InvoiceStatus {
  UNPAID
  PART_PAID
  PAID
}

enum PaymentMode {
  UPI
  BANK
  CHEQUE
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdProjects   Project[]       @relation("CreatedBy")
  salesProjects     Project[]       @relation("SalesPerson")
  opsProjects       Project[]       @relation("OpsPerson")
  assignedLeads     Lead[]          @relation("AssignedSales")
  uploadedDocuments Document[]      @relation("UploadedBy")
  auditLogs         AuditLog[]      @relation("AuditUser")
  siteSurveys       SiteSurvey[]    @relation("CompletedBy")
  projectRemarks    ProjectRemark[] @relation("RemarkAuthor")
  createdCustomers  Customer[]      @relation("CustomerCreatedBy")
  salesCustomers    Customer[]      @relation("CustomerSalesPerson")
  createdTickets    SupportTicket[] @relation("TicketCreatedBy")
  ticketActivities  SupportTicketActivity[] @relation("ActivityCreatedBy")

  @@map("users")
}

model Lead {
  id              String     @id @default(cuid())
  customerId      String
  customer        Customer   @relation(fields: [customerId], references: [id], onDelete: Restrict)
  source          LeadSource // Website, Referral, Google, Channel Partner
  systemSizeKw    Float? // System size in kW
  roofType        String?
  city            String?
  assignedSalesId String?
  assignedSales   User?      @relation("AssignedSales", fields: [assignedSalesId], references: [id], onDelete: SetNull)
  status          LeadStatus @default(NEW) // New, Qualified, Lost, Converted
  expectedValue   Float? // Expected project value
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  projects Project[] // Leads can convert to multiple projects

  @@map("leads")
}

model Customer {
  id             String        @id @default(cuid())
  customerId     String        @unique // 6-digit alphanumeric ID
  customerName   String // Legacy field, kept for backward compatibility
  prefix         String? // Mr., Ms., Mrs., Mx., Dr., etc.
  firstName      String? // Will be required after migration
  middleName     String?
  lastName       String?
  customerType   CustomerType? // Residential, Apartment, Commercial
  contactPerson  String? // Contact person name
  phone          String? // Primary phone number
  email          String?
  address        String? // Full address (keeping for backward compatibility)
  addressLine1   String? // Detailed address fields
  addressLine2   String?
  city           String?
  state          String?
  country        String?
  pinCode        String? // pincode
  latitude       Float? // Location latitude (from Google Maps)
  longitude      Float? // Location longitude (from Google Maps)
  gstNumber      String? // GST number
  contactNumbers String? // JSON array of phone numbers (legacy)
  consumerNumber String?
  idProofNumber  String?
  idProofType    String?
  companyName    String?
  companyGst     String? // Legacy field, use gstNumber

  createdById String?
  createdBy   User?   @relation("CustomerCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  salespersonId String?
  salesperson   User?   @relation("CustomerSalesPerson", fields: [salespersonId], references: [id], onDelete: SetNull)

  projects Project[]
  leads    Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

model Project {
  id   String @id @default(cuid())
  slNo Int    @unique @default(autoincrement())

  // Customer & Lead References
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)
  leadId     String? // Reference to lead if converted from lead
  lead       Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  // Project Details
  type               ProjectType
  projectServiceType ProjectServiceType @default(EPC_PROJECT) // EPC Project, Panel Cleaning, Maintenance, etc.
  salespersonId      String?
  assignedOpsId      String? // Assigned operations person
  year               String // FY format: "2024-25"
  count              Int                @default(1)

  // System Details (Professional Structure)
  systemCapacity            Float? // kW
  systemType                SystemType? // On-grid, Off-grid, Hybrid
  panelBrand                String?
  inverterBrand             String?
  roofType                  String? // Concrete-Flat, Concrete-Sloped, Tile, Thatched, Asbestos, Metal, Others
  projectStage              ProjectStage? // Survey, Proposal, Approved, Installation, Billing, Live, AMC, Lost
  stageEnteredAt            DateTime? // When current stage was entered (for SLA tracking)
  // Lost stage fields
  lostDate                  DateTime? // Date when project was marked as Lost (must be current or past date)
  lostReason                LostReason? // Reason for losing the project
  lostOtherReason           String? // Free text if lostReason is OTHER
  slaDays                   Int? // SLA days for current stage
  statusIndicator           String? // GREEN, AMBER, RED (based on SLA)
  siteAddress               String?       @db.Text // Site address for installation
  expectedCommissioningDate DateTime? // Expected commissioning date

  // Sales & Commercial
  leadSource        LeadSource? // Website, Referral, Google, Channel Partner, Digital Marketing, Other
  leadSourceDetails String? // Additional details for Channel Partner (name), Referral (name), or Other (value)
  projectCost       Float? // ₹ (project_value)
  projectValue      Float? // Alternative name for projectCost
  marginEstimate    Float? // Margin estimate
  confirmationDate  DateTime?
  loanDetails       String? // JSON: { hasLoan: boolean, remarks: string }
  incentiveEligible Boolean     @default(false)
  expectedProfit    Float? // Auto-calculated
  grossProfit       Float? // Auto-calculated: Order Value - Total Project Cost
  profitability     Float? // Auto-calculated: (Gross Profit / Order Value) × 100
  finalProfit       Float?

  // Project Execution & Compliance
  mnrePortalRegistrationDate     DateTime?
  feasibilityDate                DateTime? // KSEB
  registrationDate               DateTime? // KSEB
  installationCompletionDate     DateTime?
  completionReportSubmissionDate DateTime?
  mnreInstallationDetails        String? // JSON or text
  subsidyRequestDate             DateTime?
  subsidyCreditedDate            DateTime?
  projectStatus                  ProjectStatus @default(LEAD)
  totalProjectCost               Float? // Overall cost incurred in the project

  // Payment Tracking (Legacy - kept for backward compatibility)
  advanceReceived     Float?        @default(0)
  advanceReceivedDate DateTime?
  payment1            Float?        @default(0)
  payment1Date        DateTime?
  payment2            Float?        @default(0)
  payment2Date        DateTime?
  payment3            Float?        @default(0)
  payment3Date        DateTime?
  lastPayment         Float?        @default(0)
  lastPaymentDate     DateTime?
  totalAmountReceived Float         @default(0) // Auto-calculated
  balanceAmount       Float         @default(0) // Auto-calculated
  paymentStatus       PaymentStatus @default(PENDING) // Auto-calculated

  // Remarks & Documentation
  remarks       String? @db.Text
  internalNotes String? @db.Text // Sales only

  // Relations
  createdById String
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])

  salesperson User? @relation("SalesPerson", fields: [salespersonId], references: [id], onDelete: SetNull)
  opsPerson   User? @relation("OpsPerson", fields: [assignedOpsId], references: [id], onDelete: SetNull)

  documents      Document[]
  auditLogs      AuditLog[]
  siteSurveys    SiteSurvey[]
  proposals      Proposal[]
  installations  Installation[]
  invoices       Invoice[]
  amcContracts   AMCContract[]
  serviceTickets ServiceTicket[]
  supportTickets SupportTicket[] @relation("SupportTickets")
  projectRemarks ProjectRemark[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

model Document {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  fileName    String
  filePath    String
  fileType    String // MIME type
  fileSize    Int // bytes
  category    String // proposal, agreement, kseb, mnre, invoice, payment_proof
  description String?

  uploadedById String
  uploadedBy   User   @relation("UploadedBy", fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("documents")
}

model AuditLog {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("AuditUser", fields: [userId], references: [id])

  action   String // created, updated, deleted, status_changed, payment_updated, etc.
  field    String? // which field was changed
  oldValue String? @db.Text
  newValue String? @db.Text
  remarks  String? @db.Text

  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model SiteSurvey {
  id             String    @id @default(cuid())
  projectId      String
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  roofArea       Float? // Roof area in sq ft or sq m
  shading        String? // Shading details
  panelLayoutUrl String? // URL to panel layout document/image
  discom         String? // Distribution company name
  meterType      String? // Meter type
  remarks        String?   @db.Text
  completedById  String?
  completedBy    User?     @relation("CompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("site_surveys")
}

model Proposal {
  id              String         @id @default(cuid())
  projectId       String
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  proposalPdfUrl  String? // URL to proposal PDF
  energyOutputKwh Float? // Expected energy output in kWh
  annualSavings   Float? // Annual savings estimate
  paybackYears    Float? // Payback period in years
  price           Float? // Proposal price
  aiGenerated     Boolean        @default(false) // Whether AI generated
  sentDate        DateTime?
  status          ProposalStatus @default(DRAFT) // Draft, Sent, Approved, Rejected
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("proposals")
}

model Installation {
  id             String             @id @default(cuid())
  projectId      String
  project        Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  installerName  String? // Installer/contractor name
  startDate      DateTime?
  completionDate DateTime?
  status         InstallationStatus @default(PENDING) // Pending, In Progress, Completed
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@map("installations")
}

model Invoice {
  id            String        @id @default(cuid())
  projectId     String
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invoiceNumber String        @unique // Invoice number
  amount        Float // Base amount
  gst           Float?        @default(0) // GST amount
  total         Float // Total amount (amount + gst)
  dueDate       DateTime?
  status        InvoiceStatus @default(UNPAID) // Unpaid, Part Paid, Paid
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  payments Payment[]

  @@map("invoices")
}

model Payment {
  id          String      @id @default(cuid())
  invoiceId   String
  invoice     Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount      Float // Payment amount
  paymentDate DateTime    @default(now())
  mode        PaymentMode // UPI, Bank, Cheque
  referenceNo String? // Payment reference number
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("payments")
}

model AMCContract {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  startDate DateTime
  endDate   DateTime
  annualFee Float? // Annual maintenance fee
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("amc_contracts")
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

model SupportTicket {
  id            String              @id @default(cuid())
  ticketNumber  String              @unique // Format: RE######## (8-digit random)
  projectId     String
  project       Project             @relation("SupportTickets", fields: [projectId], references: [id], onDelete: Cascade)
  title         String              @db.VarChar(500)
  description   String?             @db.Text
  status        SupportTicketStatus @default(OPEN)
  createdById   String
  createdBy     User                @relation("TicketCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  closedAt      DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  activities SupportTicketActivity[]

  @@index([projectId])
  @@index([ticketNumber])
  @@index([status])
  @@map("support_tickets")
}

model SupportTicketActivity {
  id             String        @id @default(cuid())
  supportTicketId String
  supportTicket  SupportTicket @relation(fields: [supportTicketId], references: [id], onDelete: Cascade)
  note           String        @db.Text
  followUpDate   DateTime?
  createdById    String
  createdBy      User          @relation("ActivityCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  createdAt      DateTime      @default(now())

  @@index([supportTicketId])
  @@index([createdById])
  @@map("support_ticket_activities")
}

// Legacy ServiceTicket model - kept for backward compatibility but will be deprecated
model ServiceTicket {
  id         String    @id @default(cuid())
  projectId  String
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issue      String    @db.Text // Issue description
  status     String    @default("OPEN") // Open, In Progress, Resolved, Closed
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("service_tickets")
}

model ProjectRemark {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("RemarkAuthor", fields: [userId], references: [id], onDelete: Cascade)
  remark    String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([userId])
  @@map("project_remarks")
}
